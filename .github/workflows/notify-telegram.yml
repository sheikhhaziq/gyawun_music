name: Telegram Release Notify

on:
  workflow_call:
    inputs:
      release_tag:
        required: true
        type: string
    secrets:
      TELEGRAM_BOT_TOKEN:
        required: true
      TELEGRAM_CHAT_ID:
        required: true
      TELEGRAM_TOPIC_ALPHA:
        required: true
      TELEGRAM_TOPIC_BETA:
        required: true
      TELEGRAM_TOPIC_STABLE:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Fetch release data from GitHub
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Fetch release data
        id: release
        run: |
          set -e

          REPO="${{ github.repository }}"
          TAG="${{ inputs.release_tag }}"

          curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/releases/tags/$TAG" \
            > release.json

          BODY=$(jq -r '.body // ""' release.json)

          {
            echo "body<<EOF"
            echo "$BODY"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Detect channel and topic
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Detect channel and topic
        id: channel
        run: |
          TAG="${{ inputs.release_tag }}"

          if [[ "$TAG" == *"-alpha."* ]]; then
            NAME="Alpha"
            EMOJI="ðŸš§"
            NOTE="Highly unstable. Internal testing only."
            TOPIC="${{ secrets.TELEGRAM_TOPIC_ALPHA }}"
          elif [[ "$TAG" == *"-beta."* ]]; then
            NAME="Beta"
            EMOJI="ðŸ§ª"
            NOTE="Feature-complete. May contain bugs."
            TOPIC="${{ secrets.TELEGRAM_TOPIC_BETA }}"
          else
            NAME="Stable"
            EMOJI="ðŸš€"
            NOTE="Recommended for all users."
            TOPIC="${{ secrets.TELEGRAM_TOPIC_STABLE }}"
          fi

          {
            echo "name=$NAME"
            echo "emoji=$EMOJI"
            echo "note=$NOTE"
            echo "topic=$TOPIC"
          } >> "$GITHUB_OUTPUT"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Build inline keyboard (WAIT + NULL SAFE)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build inline keyboard (wait for assets)
        id: keyboard
        run: |
          set -e

          for i in {1..10}; do
            ASSET_COUNT=$(jq '.assets | length // 0' release.json)

            if [ "$ASSET_COUNT" -gt 0 ]; then
              echo "âœ… Assets detected ($ASSET_COUNT)"
              break
            fi

            echo "â³ Waiting for assets to appear ($i/10)..."
            sleep 3

            curl -s \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ inputs.release_tag }}" \
              > release.json
          done

          KEYBOARD=$(jq '
            [(.assets // [])[]
              | select(.name | endswith(".apk"))
              | {
                  text:
                    (if (.name | contains("universal")) then "â¬‡ Universal"
                     elif (.name | contains("arm64")) then "ðŸ“± ARM64 (Most devices)"
                     elif (.name | contains("armeabi")) then "ðŸ“± ARMv7 (32-bit)"
                     elif (.name | contains("x86_64")) then "ðŸ’» x86_64 (Emulator)"
                     else .name end),
                  url: .browser_download_url
                }
            ]
            | sort_by(.text)
            | map([.])
          ' release.json)

          echo "keyboard=$KEYBOARD" >> "$GITHUB_OUTPUT"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. Send Telegram message (emoji-safe, jq-only)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Send Telegram message with buttons
        run: |
          set -e

          jq -n \
            --arg chat "${{ secrets.TELEGRAM_CHAT_ID }}" \
            --arg thread "${{ steps.channel.outputs.topic }}" \
            --arg tag "${{ inputs.release_tag }}" \
            --arg channel "${{ steps.channel.outputs.name }}" \
            --arg emoji "${{ steps.channel.outputs.emoji }}" \
            --arg note "${{ steps.channel.outputs.note }}" \
            --arg body "${{ steps.release.outputs.body }}" \
            --argjson keyboard '${{ steps.keyboard.outputs.keyboard }}' \
            '{
              chat_id: ($chat | tonumber),
              message_thread_id: ($thread | tonumber),
              parse_mode: "Markdown",
              text:
                ($emoji + " *GyawunMusic " + $channel + " Release*\n\n"
                + "*Version:* " + $tag + "\n"
                + $note + "\n\n"
                + "*Changes:*\n"
                + ($body
                    | split("\n")
                    | map(select(length > 0))
                    | .[:5]
                    | join("\n"))
                + "\n\nðŸ”— https://github.com/${{ github.repository }}/releases/tag/" + $tag),
              reply_markup: {
                inline_keyboard: $keyboard
              }
            }' \
          | curl -s -X POST \
              -H "Content-Type: application/json" \
              "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d @-
