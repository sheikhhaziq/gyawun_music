name: Telegram Release Notify

on:
  workflow_call:
    inputs:
      release_tag:
        required: true
        type: string
      release_channel:
        required: true
        type: string
    secrets:
      TELEGRAM_BOT_TOKEN:
        required: true
      TELEGRAM_CHAT_ID:
        required: true
      TELEGRAM_TOPIC_ALPHA:
        required: true
      TELEGRAM_TOPIC_BETA:
        required: true
      TELEGRAM_TOPIC_STABLE:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Determine topic ID
        id: topic
        run: |
          CHANNEL="${{ inputs.release_channel }}"
          
          if [ "$CHANNEL" = "alpha" ]; then
            echo "id=${{ secrets.TELEGRAM_TOPIC_ALPHA }}" >> $GITHUB_OUTPUT
            echo "emoji=ðŸš§" >> $GITHUB_OUTPUT
          elif [ "$CHANNEL" = "beta" ]; then
            echo "id=${{ secrets.TELEGRAM_TOPIC_BETA }}" >> $GITHUB_OUTPUT
            echo "emoji=ðŸ§ª" >> $GITHUB_OUTPUT
          elif [ "$CHANNEL" = "stable" ] || [ "$CHANNEL" = "production" ]; then
            echo "id=${{ secrets.TELEGRAM_TOPIC_STABLE }}" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
          else
            echo "âŒ Unknown channel: $CHANNEL"
            exit 1
          fi

      - name: Fetch release data
        id: release
        run: |
          set -e

          REPO="${{ github.repository }}"
          TAG="${{ inputs.release_tag }}"

          curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/releases/tags/$TAG" \
            > release.json

          # Extract data
          RELEASE_URL=$(jq -r '.html_url // ""' release.json)
          RELEASE_NAME=$(jq -r '.name // ""' release.json)
          IS_PRERELEASE=$(jq -r '.prerelease // false' release.json)
          BODY=$(jq -r '.body // ""' release.json)

          # Get download URLs for APKs
          UNIVERSAL_URL=$(jq -r '.assets[] | select(.name | contains("universal.apk")) | .browser_download_url' release.json)
          ARM64_URL=$(jq -r '.assets[] | select(.name | contains("arm64-v8a.apk")) | .browser_download_url' release.json)
          ARMV7_URL=$(jq -r '.assets[] | select(.name | contains("armeabi-v7a.apk")) | .browser_download_url' release.json)
          X86_64_URL=$(jq -r '.assets[] | select(.name | contains("x86_64.apk")) | .browser_download_url' release.json)

          # Save to outputs
          {
            echo "url=$RELEASE_URL"
            echo "name=$RELEASE_NAME"
            echo "prerelease=$IS_PRERELEASE"
            echo "universal_url=$UNIVERSAL_URL"
            echo "arm64_url=$ARM64_URL"
            echo "armv7_url=$ARMV7_URL"
            echo "x86_64_url=$X86_64_URL"
            echo "body<<EOF"
            echo "$BODY"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Send Telegram notification
        run: |
          CHANNEL="${{ inputs.release_channel }}"
          EMOJI="${{ steps.topic.outputs.emoji }}"
          
          # Prepare message
          MESSAGE="$EMOJI <b>New ${CHANNEL^} Release</b> $EMOJI

ðŸ“¦ <b>${{ steps.release.outputs.name }}</b>

ðŸ”— <a href=\"${{ steps.release.outputs.url }}\">View Release on GitHub</a>

${{ steps.release.outputs.body }}"

          # Prepare inline keyboard with download buttons
          KEYBOARD=$(cat <<EOF
          {
            "inline_keyboard": [
              [
                {"text": "ðŸ“± Universal APK", "url": "${{ steps.release.outputs.universal_url }}"}
              ],
              [
                {"text": "ðŸŽ¯ ARM64 (v8a)", "url": "${{ steps.release.outputs.arm64_url }}"},
                {"text": "ðŸŽ¯ ARMv7", "url": "${{ steps.release.outputs.armv7_url }}"}
              ],
              [
                {"text": "ðŸŽ¯ x86_64", "url": "${{ steps.release.outputs.x86_64_url }}"}
              ],
              [
                {"text": "ðŸ“„ Full Release Notes", "url": "${{ steps.release.outputs.url }}"}
              ]
            ]
          }
          EOF
          )

          # Send to Telegram
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"message_thread_id\": ${{ steps.topic.outputs.id }},
              \"text\": $(echo "$MESSAGE" | jq -Rs .),
              \"parse_mode\": \"HTML\",
              \"reply_markup\": $KEYBOARD,
              \"disable_web_page_preview\": true
            }"

      - name: Verify notification sent
        run: echo "âœ… Telegram notification sent successfully to ${{ inputs.release_channel }} topic!"